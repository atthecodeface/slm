
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>state.py &#8212; Streamlines  documentation</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="core.py" href="core.html" />
    <link rel="prev" title="parameters.py" href="parameters.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="module-streamlines.state">
<span id="state-py"></span><h1><code class="docutils literal notranslate"><span class="pre">state.py</span></code><a class="headerlink" href="#module-streamlines.state" title="Permalink to this headline">¶</a></h1>
<hr class="docutils" />
<p>Mask wrangling and more.</p>
<hr class="docutils" />
<dl class="docutils">
<dt>Requires Python packages/modules:</dt>
<dd><ul class="first last simple">
<li><a class="reference external" href="https://docs.python.org/3/library/json.html#module-json" title="(in Python v3.7)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">json</span></code></a></li>
<li><a class="reference external" href="https://docs.python.org/3/library/collections.html#module-collections" title="(in Python v3.7)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">collections</span></code></a></li>
</ul>
</dd>
</dl>
<p>Imports <a class="reference internal" href="core.html#streamlines.core.Core" title="streamlines.core.Core"><code class="xref py py-class docutils literal notranslate"><span class="pre">Core</span></code></a> class</p>
<p>Imports functions from: <a class="reference internal" href="useful.html#module-streamlines.useful" title="streamlines.useful"><code class="xref py py-mod docutils literal notranslate"><span class="pre">useful</span></code></a> module</p>
<hr class="docutils" />
<dl class="class">
<dt id="streamlines.state.State">
<em class="property">class </em><code class="descclassname">streamlines.state.</code><code class="descname">State</code><span class="sig-paren">(</span><em>state</em>, <em>imported_parameters</em><span class="sig-paren">)</span><a class="headerlink" href="#streamlines.state.State" title="Permalink to this definition">¶</a></dt>
<dd><p>Class providing a variety of read/write and assignment methods to initialize,
record and reload run state.</p>
<dl class="method">
<dt id="streamlines.state.State.add_active_mask">
<code class="descname">add_active_mask</code><span class="sig-paren">(</span><em>mask_item</em><span class="sig-paren">)</span><a class="headerlink" href="#streamlines.state.State.add_active_mask" title="Permalink to this definition">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><strong>TBD</strong> (<em>TBD</em>) – </td>
</tr>
</tbody>
</table>
<p>TBD</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Returns:</th><td class="field-body">TBD</td>
</tr>
<tr class="field-even field"><th class="field-name">Return type:</th><td class="field-body">TBD</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="streamlines.state.State.get_dict_of_jsonables">
<code class="descname">get_dict_of_jsonables</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#streamlines.state.State.get_dict_of_jsonables" title="Permalink to this definition">¶</a></dt>
<dd><p>Collect lists of JSONable objects in hierarchical dictionary</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><strong>TBD</strong> (<em>TBD</em>) – </td>
</tr>
</tbody>
</table>
<p>TBD</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Returns:</th><td class="field-body">TBD</td>
</tr>
<tr class="field-even field"><th class="field-name">Return type:</th><td class="field-body">TBD</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="streamlines.state.State.get_sizes_of_nparrays">
<code class="descname">get_sizes_of_nparrays</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#streamlines.state.State.get_sizes_of_nparrays" title="Permalink to this definition">¶</a></dt>
<dd><p>Collect lists of savezable numpy arrays in hierarchical dictionary
and calculate their total memory usage</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><strong>TBD</strong> (<em>TBD</em>) – </td>
</tr>
</tbody>
</table>
<p>TBD</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Returns:</th><td class="field-body">TBD</td>
</tr>
<tr class="field-even field"><th class="field-name">Return type:</th><td class="field-body">TBD</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="streamlines.state.State.get_streamlines_dict">
<code class="descname">get_streamlines_dict</code><span class="sig-paren">(</span><em>array_list</em><span class="sig-paren">)</span><a class="headerlink" href="#streamlines.state.State.get_streamlines_dict" title="Permalink to this definition">¶</a></dt>
<dd><p>Collect list of streamline numpy arrays</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><strong>TBD</strong> (<em>TBD</em>) – </td>
</tr>
</tbody>
</table>
<p>TBD</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Returns:</th><td class="field-body">TBD</td>
</tr>
<tr class="field-even field"><th class="field-name">Return type:</th><td class="field-body">TBD</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="streamlines.state.State.get_streamlines_sizes">
<code class="descname">get_streamlines_sizes</code><span class="sig-paren">(</span><em>array_list</em><span class="sig-paren">)</span><a class="headerlink" href="#streamlines.state.State.get_streamlines_sizes" title="Permalink to this definition">¶</a></dt>
<dd><p>Collect list of streamline numpy arrays</p>
</dd></dl>

<dl class="method">
<dt id="streamlines.state.State.inventorize_run_state">
<code class="descname">inventorize_run_state</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#streamlines.state.State.inventorize_run_state" title="Permalink to this definition">¶</a></dt>
<dd><p>Build dictionary of lists of workflow class instance variables, grouped
according to how they can be exported to files.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><strong>TBD</strong> (<em>TBD</em>) – </td>
</tr>
</tbody>
</table>
<p>TBD</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Returns:</th><td class="field-body">TBD</td>
</tr>
<tr class="field-even field"><th class="field-name">Return type:</th><td class="field-body">TBD</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="streamlines.state.State.list_active_masks">
<code class="descname">list_active_masks</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#streamlines.state.State.list_active_masks" title="Permalink to this definition">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><strong>TBD</strong> (<em>TBD</em>) – </td>
</tr>
</tbody>
</table>
<p>TBD</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Returns:</th><td class="field-body">TBD</td>
</tr>
<tr class="field-even field"><th class="field-name">Return type:</th><td class="field-body">TBD</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="streamlines.state.State.merge_active_masks">
<code class="descname">merge_active_masks</code><span class="sig-paren">(</span><em>out=None</em><span class="sig-paren">)</span><a class="headerlink" href="#streamlines.state.State.merge_active_masks" title="Permalink to this definition">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><strong>TBD</strong> (<em>TBD</em>) – </td>
</tr>
</tbody>
</table>
<p>TBD</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Returns:</th><td class="field-body">TBD</td>
</tr>
<tr class="field-even field"><th class="field-name">Return type:</th><td class="field-body">TBD</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="streamlines.state.State.read_hdf5">
<code class="descname">read_hdf5</code><span class="sig-paren">(</span><em>filename</em><span class="sig-paren">)</span><a class="headerlink" href="#streamlines.state.State.read_hdf5" title="Permalink to this definition">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><strong>TBD</strong> (<em>TBD</em>) – </td>
</tr>
</tbody>
</table>
<p>TBD</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Returns:</th><td class="field-body">TBD</td>
</tr>
<tr class="field-even field"><th class="field-name">Return type:</th><td class="field-body">TBD</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="streamlines.state.State.remove_active_mask">
<code class="descname">remove_active_mask</code><span class="sig-paren">(</span><em>mask_name</em><span class="sig-paren">)</span><a class="headerlink" href="#streamlines.state.State.remove_active_mask" title="Permalink to this definition">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><strong>TBD</strong> (<em>TBD</em>) – </td>
</tr>
</tbody>
</table>
<p>TBD</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Returns:</th><td class="field-body">TBD</td>
</tr>
<tr class="field-even field"><th class="field-name">Return type:</th><td class="field-body">TBD</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="streamlines.state.State.reset_active_masks">
<code class="descname">reset_active_masks</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#streamlines.state.State.reset_active_masks" title="Permalink to this definition">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><strong>TBD</strong> (<em>TBD</em>) – </td>
</tr>
</tbody>
</table>
<p>TBD</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Returns:</th><td class="field-body">TBD</td>
</tr>
<tr class="field-even field"><th class="field-name">Return type:</th><td class="field-body">TBD</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="streamlines.state.State.save_state">
<code class="descname">save_state</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#streamlines.state.State.save_state" title="Permalink to this definition">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><strong>TBD</strong> (<em>TBD</em>) – </td>
</tr>
</tbody>
</table>
<p>Save working state to a set of JSON and other files.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Returns:</th><td class="field-body">TBD</td>
</tr>
<tr class="field-even field"><th class="field-name">Return type:</th><td class="field-body">TBD</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="streamlines.state.State.savez_dicts_of_nparrays">
<code class="descname">savez_dicts_of_nparrays</code><span class="sig-paren">(</span><em>filestem</em><span class="sig-paren">)</span><a class="headerlink" href="#streamlines.state.State.savez_dicts_of_nparrays" title="Permalink to this definition">¶</a></dt>
<dd><p>Collect lists of savezable numpy arrays in hierarchical dictionary
and save to compressed file (npz)</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><strong>TBD</strong> (<em>TBD</em>) – </td>
</tr>
</tbody>
</table>
<p>TBD</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Returns:</th><td class="field-body">TBD</td>
</tr>
<tr class="field-even field"><th class="field-name">Return type:</th><td class="field-body">TBD</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="streamlines.state.State.set_savestate_filename">
<code class="descname">set_savestate_filename</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#streamlines.state.State.set_savestate_filename" title="Permalink to this definition">¶</a></dt>
<dd><p>Set workflow state JSON filename.</p>
<p>The filename is set according to whether the input parameters file is
a numbered ‘_savestateXX.json’ file.
If no, the input JSON filename has ‘_savestate0’ appended.
If yes, its iteration number XX is incremented.</p>
<dl class="attribute">
<dt id="streamlines.state.State.state_filename">
<code class="descname">state_filename</code><a class="headerlink" href="#streamlines.state.State.state_filename" title="Permalink to this definition">¶</a></dt>
<dd><p><em>str</em> – Name of destination JSON file to save workflow state,</p>
</dd></dl>

<dl class="attribute">
<dt>
<code class="descname">with increment number suffix set appropriately.</code></dt>
<dd></dd></dl>

</dd></dl>

<dl class="method">
<dt id="streamlines.state.State.write_hdf5">
<code class="descname">write_hdf5</code><span class="sig-paren">(</span><em>filename</em>, <em>nparray_list</em>, <em>nparraylist_list</em><span class="sig-paren">)</span><a class="headerlink" href="#streamlines.state.State.write_hdf5" title="Permalink to this definition">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><strong>TBD</strong> (<em>TBD</em>) – </td>
</tr>
</tbody>
</table>
<p>TBD</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Returns:</th><td class="field-body">TBD</td>
</tr>
<tr class="field-even field"><th class="field-name">Return type:</th><td class="field-body">TBD</td>
</tr>
</tbody>
</table>
</dd></dl>

</dd></dl>

<div class="section" id="code">
<h2>Code<a class="headerlink" href="#code" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">---------------------------------------------------------------------</span>

<span class="sd">Mask wrangling and more.</span>
<span class="sd">    </span>
<span class="sd">---------------------------------------------------------------------</span>
<span class="sd">    </span>
<span class="sd">Requires Python packages/modules:</span>
<span class="sd">  -  :mod:`json`</span>
<span class="sd">  -  :mod:`collections`</span>

<span class="sd">Imports :class:`.Core` class</span>

<span class="sd">Imports functions from: :mod:`.useful` module</span>
<span class="sd"> </span>
<span class="sd">---------------------------------------------------------------------</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">collections</span>     <span class="k">import</span> <span class="n">ChainMap</span>

<span class="kn">from</span> <span class="nn">streamlines.core</span> <span class="k">import</span> <span class="n">Core</span>
<span class="kn">from</span> <span class="nn">streamlines.useful</span> <span class="k">import</span> <span class="n">neatly</span><span class="p">,</span> <span class="n">true_size</span>
<span class="n">pdebug</span> <span class="o">=</span> <span class="nb">print</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;State&#39;</span><span class="p">]</span>

<span class="k">class</span> <span class="nc">State</span><span class="p">(</span><span class="n">Core</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class providing a variety of read/write and assignment methods to initialize, </span>
<span class="sd">    record and reload run state.</span>
<span class="sd">    &quot;&quot;&quot;</span>   
    <span class="k">def</span> <span class="nf">set_savestate_filename</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set workflow state JSON filename.</span>
<span class="sd">        </span>
<span class="sd">        The filename is set according to whether the input parameters file is </span>
<span class="sd">        a numbered &#39;_savestateXX.json&#39; file.</span>
<span class="sd">        If no, the input JSON filename has &#39;_savestate0&#39; appended.</span>
<span class="sd">        If yes, its iteration number XX is incremented.</span>
<span class="sd">        </span>
<span class="sd">        Attributes:</span>
<span class="sd">            state_filename (str): Name of destination JSON file to save workflow state, </span>
<span class="sd">            with increment number suffix set appropriately.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">base_filename_split</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters_file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_savestate&#39;</span><span class="p">)</span>
<span class="c1">#         print(base_filename_split)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">save_iteration</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">base_filename_split</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">save_iteration</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">state_filename</span> <span class="o">=</span> <span class="n">base_filename_split</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_savestate&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">save_iteration</span><span class="p">)</span>
<span class="c1">#         if os.path.isfile(os.path.join(*self.export_path,state_filename+&#39;.json&#39;)):</span>
<span class="c1">#             print(state_filename)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state_filename</span> <span class="o">=</span> <span class="n">state_filename</span>
    
    <span class="k">def</span> <span class="nf">inventorize_run_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build dictionary of lists of workflow class instance variables, grouped </span>
<span class="sd">        according to how they can be exported to files.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            TBD (TBD): </span>
<span class="sd">        </span>
<span class="sd">        TBD</span>
<span class="sd">    </span>
<span class="sd">        Returns:</span>
<span class="sd">            TBD: </span>
<span class="sd">            TBD</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">**Inventorize run state begin**&#39;</span><span class="p">)</span>  
        <span class="bp">self</span><span class="o">.</span><span class="n">inventory</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj_list</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">inventorize</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s1">&#39;**Inventorize run state end**</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
     
    <span class="k">def</span> <span class="nf">get_dict_of_jsonables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Collect lists of JSONable objects in hierarchical dictionary</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            TBD (TBD): </span>
<span class="sd">        </span>
<span class="sd">        TBD</span>
<span class="sd">    </span>
<span class="sd">        Returns:</span>
<span class="sd">            TBD: </span>
<span class="sd">            TBD</span>
<span class="sd">        &quot;&quot;&quot;</span>        
        <span class="n">full_jsonable_export_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">total_usage</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj_list</span><span class="p">:</span>
            <span class="n">obj_name</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__module__</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">inventory_item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inventory</span><span class="p">[</span><span class="n">obj_name</span><span class="p">]</span>
<span class="c1">#             print(&#39;\n&#39;,obj_name,inventory_item,&#39;\n&#39;)</span>
            
            <span class="n">jsonable_list</span> <span class="o">=</span> <span class="n">inventory_item</span><span class="p">[</span><span class="s1">&#39;jsonable&#39;</span><span class="p">]</span>
            <span class="n">jsonable_export_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">jsonable_item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inventory</span><span class="p">[</span><span class="n">obj_name</span><span class="p">][</span><span class="s1">&#39;jsonable&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">obj_name</span><span class="o">==</span><span class="s1">&#39;state&#39;</span> <span class="ow">and</span> <span class="n">jsonable_item</span><span class="o">==</span><span class="s1">&#39;inventory&#39;</span><span class="p">:</span>
                    <span class="k">continue</span>
<span class="c1">#                 elif obj_name==&#39;plot&#39; and jsonable_item==&#39;figs&#39;:</span>
<span class="c1">#                     continue</span>
                <span class="n">jsonable_obj</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="n">jsonable_item</span><span class="p">)</span>
                <span class="n">jsonable_export_list</span> <span class="o">+=</span> <span class="p">[{</span><span class="n">jsonable_item</span> <span class="p">:</span> <span class="n">jsonable_obj</span><span class="p">}</span> <span class="p">]</span>
                <span class="n">total_usage</span> <span class="o">+=</span> <span class="n">true_size</span><span class="p">(</span><span class="n">jsonable_obj</span><span class="p">)</span>
            <span class="n">d</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">ChainMap</span><span class="p">(</span><span class="o">*</span><span class="n">jsonable_export_list</span><span class="p">))</span>
            <span class="n">full_jsonable_export_list</span> <span class="o">+=</span> <span class="p">[{</span><span class="n">obj_name</span> <span class="p">:</span> <span class="n">d</span><span class="p">}]</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">ChainMap</span><span class="p">(</span><span class="o">*</span><span class="n">full_jsonable_export_list</span><span class="p">)),</span> <span class="n">total_usage</span>
    
    <span class="k">def</span> <span class="nf">savez_dicts_of_nparrays</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filestem</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Collect lists of savezable numpy arrays in hierarchical dictionary</span>
<span class="sd">        and save to compressed file (npz)</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            TBD (TBD): </span>
<span class="sd">        </span>
<span class="sd">        TBD</span>
<span class="sd">    </span>
<span class="sd">        Returns:</span>
<span class="sd">            TBD: </span>
<span class="sd">            TBD</span>
<span class="sd">        &quot;&quot;&quot;</span>        
        <span class="n">trimmed_obj_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">obj</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj_list</span> 
                            <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__module__</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                            <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;preprocess&#39;</span><span class="p">,</span><span class="s1">&#39;trace&#39;</span><span class="p">,</span><span class="s1">&#39;analysis&#39;</span><span class="p">]]</span>
        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">trimmed_obj_list</span><span class="p">:</span>

            <span class="n">obj_name</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__module__</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">filestem</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">obj_name</span><span class="o">+</span><span class="s1">&#39;.npz&#39;</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s1">&#39;Saving &quot;&#39;</span><span class="o">+</span><span class="n">obj_name</span><span class="o">+</span><span class="s1">&#39;&quot; state np arrays to: &quot;&#39;</span><span class="o">+</span><span class="n">filename</span><span class="o">+</span><span class="s1">&#39;&quot;...&#39;</span><span class="p">,</span> 
                      <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            
            <span class="n">nparray_export_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">nparray</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inventory</span><span class="p">[</span><span class="n">obj_name</span><span class="p">][</span><span class="s1">&#39;nparray&#39;</span><span class="p">]:</span>
                <span class="n">nparray_export_list</span> <span class="o">+=</span> <span class="p">[{</span><span class="n">obj_name</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="n">nparray</span> <span class="p">:</span> 
                                         <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="n">nparray</span><span class="p">)}</span> <span class="p">]</span>
            <span class="n">np</span><span class="o">.</span><span class="n">savez_compressed</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="o">**</span><span class="nb">dict</span><span class="p">(</span><span class="n">ChainMap</span><span class="p">(</span><span class="o">*</span><span class="n">nparray_export_list</span><span class="p">)))</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s1">&#39;...done&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_sizes_of_nparrays</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Collect lists of savezable numpy arrays in hierarchical dictionary</span>
<span class="sd">        and calculate their total memory usage</span>
<span class="sd">        </span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            TBD (TBD): </span>
<span class="sd">        </span>
<span class="sd">        TBD</span>
<span class="sd">    </span>
<span class="sd">        Returns:</span>
<span class="sd">            TBD: </span>
<span class="sd">            TBD</span>
<span class="sd">        &quot;&quot;&quot;</span>        
        <span class="n">trimmed_obj_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">obj</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj_list</span> 
                            <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__module__</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> 
                            <span class="p">[</span><span class="s1">&#39;preprocess&#39;</span><span class="p">,</span><span class="s1">&#39;trace&#39;</span><span class="p">,</span><span class="s1">&#39;analysis&#39;</span><span class="p">]]</span>
        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">trimmed_obj_list</span><span class="p">:</span>

            <span class="n">obj_name</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__module__</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>            
            <span class="n">total_usage</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">nparray</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inventory</span><span class="p">[</span><span class="n">obj_name</span><span class="p">][</span><span class="s1">&#39;nparray&#39;</span><span class="p">]:</span>
                <span class="n">total_usage</span> <span class="o">+=</span> <span class="n">true_size</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="n">nparray</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">total_usage</span>
    
    <span class="k">def</span> <span class="nf">get_streamlines_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">array_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Collect list of streamline numpy arrays </span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            TBD (TBD): </span>
<span class="sd">        </span>
<span class="sd">        TBD</span>
<span class="sd">    </span>
<span class="sd">        Returns:</span>
<span class="sd">            TBD: </span>
<span class="sd">            TBD</span>
<span class="sd">        &quot;&quot;&quot;</span>   
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">ChainMap</span><span class="p">(</span><span class="o">*</span><span class="p">[{</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span><span class="n">arr</span><span class="p">}</span> 
                               <span class="k">for</span> <span class="n">idx</span><span class="p">,</span><span class="n">arr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">array_list</span><span class="p">)]))</span>
        
    <span class="k">def</span> <span class="nf">get_streamlines_sizes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">array_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Collect list of streamline numpy arrays </span>
<span class="sd">        &quot;&quot;&quot;</span>   
        <span class="k">return</span> <span class="nb">sum</span><span class="p">([</span><span class="n">true_size</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span> <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">array_list</span><span class="p">])</span>
        
    <span class="k">def</span> <span class="nf">save_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            TBD (TBD): </span>
<span class="sd">            </span>
<span class="sd">        Save working state to a set of JSON and other files.</span>
<span class="sd">    </span>
<span class="sd">        Returns:</span>
<span class="sd">            TBD: </span>
<span class="sd">            TBD</span>
<span class="sd">        &quot;&quot;&quot;</span> 

        <span class="c1">#################################################################</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">**Save state begin**&#39;</span><span class="p">)</span>  
        <span class="c1">#################################################################</span>
            
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">export_path</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s1">&#39;State directory doesn</span><span class="se">\&#39;</span><span class="s1">t exist: creating &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span>
                      <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">export_path</span><span class="p">))</span>  
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">export_path</span><span class="p">))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s1">&#39;Cannot create state directory &quot;&#39;</span>
                              <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">export_path</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">export_path</span><span class="p">)):</span>
                <span class="n">err</span> <span class="o">=</span> <span class="s1">&#39;&quot;&#39;</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">export_path</span><span class="p">)</span> <span class="o">+</span><span class="s1">&#39;&quot; is not a directory&#39;</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;OS error: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
                <span class="k">raise</span> <span class="ne">OSError</span>
        
    
        <span class="bp">self</span><span class="o">.</span><span class="n">set_savestate_filename</span><span class="p">()</span>
        <span class="n">filestem</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">export_path</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">state_filename</span><span class="p">))</span>
        
        <span class="c1"># JSONables</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">filestem</span><span class="o">+</span><span class="s1">&#39;.json&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s1">&#39;Saving runtime state JSONable parameters to: &quot;&#39;</span><span class="o">+</span><span class="n">filename</span><span class="o">+</span><span class="s1">&#39;&quot;...&#39;</span><span class="p">,</span> 
                  <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>       
        <span class="n">dict_of_jsonable_dicts</span><span class="p">,</span> <span class="n">total_jsonable_usage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dict_of_jsonables</span><span class="p">()</span>
<span class="c1">#         pdebug(&#39;\n\n\nAllegedly jsonable dict:&#39;, dict_of_jsonable_dicts)</span>
<span class="c1">#         pdebug(&#39;\n\n\nAllegedly jsonable dict:&#39;, json.dumps(dict_of_jsonable_dicts,indent=3))</span>
        <span class="n">copy_dict_of_jsonable_dicts</span> <span class="o">=</span> <span class="n">dict_of_jsonable_dicts</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">jsonable_dict_tuple</span> <span class="ow">in</span> <span class="n">copy_dict_of_jsonable_dicts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">copy_jsonable_dict</span> <span class="o">=</span> <span class="n">jsonable_dict_tuple</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="c1">#             pdebug(&#39;\nConverting dict?:&#39;, jsonable_dict[0],jsonable_dict[1],type(jsonable_dict[1]))</span>
            <span class="k">for</span> <span class="n">jsonable_item</span> <span class="ow">in</span> <span class="n">copy_jsonable_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">jsonable_item</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">==</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">jsonable_item</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">==</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">:</span>
                    <span class="n">conv_jsonable_item</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">jsonable_item</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">jsonable_item</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">==</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">jsonable_item</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">==</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span> \
                        <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">jsonable_item</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">==</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">jsonable_item</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">==</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span> \
                        <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">jsonable_item</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">==</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">jsonable_item</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">==</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span> \
                        <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">jsonable_item</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">==</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">jsonable_item</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">==</span><span class="n">np</span><span class="o">.</span><span class="n">uint64</span><span class="p">:</span>
                        <span class="n">conv_jsonable_item</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">jsonable_item</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">jsonable_item</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">==</span><span class="n">np</span><span class="o">.</span><span class="n">bool8</span><span class="p">:</span>
                    <span class="n">conv_jsonable_item</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">jsonable_item</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">conv_jsonable_item</span> <span class="o">=</span> <span class="n">jsonable_item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="c1">#                 pdebug(&#39;\nConverting:&#39;, jsonable_item,type(jsonable_item[1]), &#39;-&gt;&#39;,conv_jsonable_item,type(conv_jsonable_item))</span>
                <span class="n">jsonable_dict_tuple</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">jsonable_item</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">conv_jsonable_item</span>
<span class="c1">#                 pdebug(jsonable_dict_tuple)</span>
<span class="c1">#             dict_of_jsonable_dicts[jsonable_dict_tuple[0]] = jsonable_dict_tuple[1]</span>
            
<span class="c1">#         pdebug(copy_dict_of_jsonable_dicts)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">copy_dict_of_jsonable_dicts</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s1">&#39;...done&#39;</span><span class="p">)</span>

        <span class="c1"># Numpy arrays</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">savez_dicts_of_nparrays</span><span class="p">(</span><span class="n">filestem</span><span class="p">)</span>
        <span class="n">total_nparray_usage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sizes_of_nparrays</span><span class="p">()</span>

        <span class="c1"># Downstreamline and upstreamline lists of arrays</span>
        <span class="n">total_streamlines_usage</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">up_or_down_str</span><span class="p">,</span><span class="n">array_list</span> <span class="ow">in</span> <span class="p">[[</span><span class="s1">&#39;downstreamline&#39;</span><span class="p">,</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">streamline_arrays_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
                                          <span class="p">[</span><span class="s1">&#39;upstreamline&#39;</span><span class="p">,</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">streamline_arrays_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]]]:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">filestem</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">up_or_down_str</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s1">&#39;Saving &#39;</span><span class="o">+</span><span class="n">up_or_down_str</span><span class="o">+</span><span class="s1">&#39;lines to: &quot;&#39;</span><span class="o">+</span><span class="n">filename</span><span class="o">+</span><span class="s1">&#39;.npz&#39;</span><span class="o">+</span><span class="s1">&#39;&quot;...&#39;</span><span class="p">,</span> 
                      <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">streamlines_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_streamlines_dict</span><span class="p">(</span><span class="n">array_list</span><span class="p">)</span>
            <span class="n">total_streamlines_usage</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_streamlines_sizes</span><span class="p">(</span><span class="n">array_list</span><span class="p">)</span>
            <span class="n">np</span><span class="o">.</span><span class="n">savez_compressed</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="o">**</span><span class="n">streamlines_dict</span><span class="p">)</span>
            <span class="k">del</span><span class="p">(</span><span class="n">streamlines_dict</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s1">&#39;...done&#39;</span><span class="p">)</span>

        <span class="c1">#################################################################</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s1">&#39;Total JSONable memory usage:&#39;</span><span class="p">,</span> 
                  <span class="n">neatly</span><span class="p">(</span><span class="n">total_jsonable_usage</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s1">&#39;Total numpy arrays memory usage (exc streamlines):&#39;</span><span class="p">,</span> 
                  <span class="n">neatly</span><span class="p">(</span><span class="n">total_nparray_usage</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s1">&#39;Total streamline arrays memory usage:&#39;</span><span class="p">,</span> 
                  <span class="n">neatly</span><span class="p">(</span><span class="n">total_streamlines_usage</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s1">&#39;**Save state end**</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="c1">#################################################################</span>

<span class="c1">#     def read_state(self,filename):</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         Read archived run state from a group of archive files.</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         if self.do_rw_savez:</span>
<span class="c1">#             try:</span>
<span class="c1">#                 self.read_savez(filename)</span>
<span class="c1">#             except:</span>
<span class="c1">#                 raise ValueError(&#39;Cannot open savez file:&#39;, filename+&#39;.npz&#39;)</span>
<span class="c1">#         if self.do_rw_hdf5:</span>
<span class="c1">#             try:</span>
<span class="c1">#                 self.read_hdf5(filename)</span>
<span class="c1">#             except:</span>
<span class="c1">#                 raise ValueError(&#39;Cannot open HDF5 file:&#39;, filename+&#39;.h5&#39;)</span>

    <span class="k">def</span> <span class="nf">write_hdf5</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">nparray_list</span><span class="p">,</span> <span class="n">nparraylist_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            TBD (TBD): </span>
<span class="sd">        </span>
<span class="sd">        TBD</span>
<span class="sd">    </span>
<span class="sd">        Returns:</span>
<span class="sd">            TBD: </span>
<span class="sd">            TBD</span>
<span class="sd">        &quot;&quot;&quot;</span> 
        <span class="n">nparray_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">nparray_list</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
            <span class="n">nparray_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">item</span><span class="p">:</span><span class="n">value</span><span class="p">})</span>
        <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">filename</span><span class="o">+</span><span class="s1">&#39;.h5&#39;</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">hf</span><span class="p">:</span>
            <span class="n">group</span> <span class="o">=</span> <span class="n">hf</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s1">&#39;nparrays&#39;</span><span class="p">)</span>
<span class="c1">#             print(&#39;writing to&#39;,filename)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s1">&#39;Writing to HDF5 group &quot;nparrays&quot;:&#39;</span><span class="p">)</span>
<span class="c1">#             group.create_dataset(&#39;dtm_array&#39;, data=self.dtm_array)</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">nparray_list</span><span class="p">:</span>

                <span class="k">if</span> <span class="n">item</span><span class="o">==</span><span class="s1">&#39;dtm_array&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">noisy</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Skip writing of DTM since we can fetch from original&#39;</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;array_list&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
<span class="c1">#                     if self.noisy:</span>
<span class="c1">#                         print(item)</span>
<span class="c1">#                     if getattr(self, item).size==1 and getattr(self, item)==None: </span>
<span class="c1">#                         continue</span>
                    <span class="n">group</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">))</span>
<span class="c1">#                                          ,dtype=getattr(self, item).dtype</span>
<span class="c1">#                                          ,compression=&#39;gzip&#39;)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">subgroup</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span><span class="n">array</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">)):</span>
                        <span class="n">subgroup</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">),</span> <span class="n">data</span><span class="o">=</span><span class="n">array</span><span class="p">)</span>
<span class="c1">#                                          ,dtype=getattr(self, item).dtype</span>
<span class="c1">#                                          ,compression=&#39;gzip&#39;)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">print</span><span class="p">()</span>
                
    <span class="k">def</span> <span class="nf">read_hdf5</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            TBD (TBD): </span>
<span class="sd">        </span>
<span class="sd">        TBD</span>
<span class="sd">    </span>
<span class="sd">        Returns:</span>
<span class="sd">            TBD: </span>
<span class="sd">            TBD</span>
<span class="sd">        &quot;&quot;&quot;</span> 
        <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">filename</span><span class="o">+</span><span class="s1">&#39;.h5&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">hf</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Trying to read HDF5 file &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">filename</span><span class="o">+</span><span class="s1">&#39;.h5&#39;</span><span class="p">)</span> <span class="p">)</span>
            <span class="n">arrays</span> <span class="o">=</span> <span class="n">hf</span><span class="p">[</span><span class="n">filename</span><span class="p">][:]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">noisy</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">arrays</span><span class="p">)</span>
<span class="c1">#         for item in arrays:</span>
<span class="c1">#             setattr(self, item,arrays[item])</span>
<span class="c1">#         if self.noisy:</span>
<span class="c1">#             print(&#39;Arrays read from hdf5:&#39;)</span>
<span class="c1">#             [print(npz_array) for npz_array in arrays.files]</span>
<span class="c1">#             print(&#39;&#39;)</span>
        <span class="k">del</span> <span class="n">arrays</span>
        
    <span class="k">def</span> <span class="nf">add_active_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mask_item</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            TBD (TBD): </span>
<span class="sd">        </span>
<span class="sd">        TBD</span>
<span class="sd">    </span>
<span class="sd">        Returns:</span>
<span class="sd">            TBD: </span>
<span class="sd">            TBD</span>
<span class="sd">        &quot;&quot;&quot;</span> 
        <span class="c1"># Don&#39;t try to add if already there</span>
        <span class="k">if</span> <span class="nb">list</span><span class="p">(</span><span class="n">mask_item</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_masks_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">active_masks_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">mask_item</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">remove_active_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mask_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            TBD (TBD): </span>
<span class="sd">        </span>
<span class="sd">        TBD</span>
<span class="sd">    </span>
<span class="sd">        Returns:</span>
<span class="sd">            TBD: </span>
<span class="sd">            TBD</span>
<span class="sd">        &quot;&quot;&quot;</span> 
        <span class="c1"># Don&#39;t try to remove if not there</span>
        <span class="k">if</span> <span class="n">mask_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_masks_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">active_masks_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">mask_name</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">list_active_masks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            TBD (TBD): </span>
<span class="sd">        </span>
<span class="sd">        TBD</span>
<span class="sd">    </span>
<span class="sd">        Returns:</span>
<span class="sd">            TBD: </span>
<span class="sd">            TBD</span>
<span class="sd">        &quot;&quot;&quot;</span> 
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_masks_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        
    <span class="k">def</span> <span class="nf">reset_active_masks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            TBD (TBD): </span>
<span class="sd">        </span>
<span class="sd">        TBD</span>
<span class="sd">    </span>
<span class="sd">        Returns:</span>
<span class="sd">            TBD: </span>
<span class="sd">            TBD</span>
<span class="sd">        &quot;&quot;&quot;</span> 
        <span class="c1"># Clear all but the most basic masks</span>
        <span class="n">masks_keep_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;dtm&#39;</span><span class="p">,</span> <span class="s1">&#39;basin&#39;</span><span class="p">,</span> <span class="s1">&#39;uv&#39;</span><span class="p">]</span>
        <span class="c1"># Rebuild dict since in-situ deletion in list comprehension doesn&#39;t work</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">active_masks_dict</span> \
            <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_masks_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_masks_dict</span> 
                                            <span class="k">if</span>  <span class="n">k</span> <span class="ow">in</span> <span class="n">masks_keep_list</span><span class="p">}</span>
        
    <span class="k">def</span> <span class="nf">merge_active_masks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            TBD (TBD): </span>
<span class="sd">        </span>
<span class="sd">        TBD</span>
<span class="sd">    </span>
<span class="sd">        Returns:</span>
<span class="sd">            TBD: </span>
<span class="sd">            TBD</span>
<span class="sd">        &quot;&quot;&quot;</span> 
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_masks_dict</span><span class="o">==</span><span class="p">{}:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="c1"># Create a mask from a blend of all those active</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">mask_array</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">active_masks_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">idx</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">out</span> <span class="o">=</span> <span class="n">mask_array</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1">#  numpy.copyto(dst, src, casting=&#39;same_kind&#39;, where=True)</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">copyto</span><span class="p">(</span><span class="n">out</span><span class="p">,</span><span class="n">mask_array</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">|=</span> <span class="n">mask_array</span>
        <span class="k">return</span> <span class="n">out</span>
        
                
</pre></div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../index.html">
    <img class="logo" src="../_static/../_images/icon3.png" alt="Logo"/>
    
    <h1 class="logo logo-name">Streamlines</h1>
    
  </a>
</p>



<p class="blurb">Topographic streamline mapping of landscape structure</p>







<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
  <br>
  <p class="biglink"><a class="biglink" href="../py-modindex.html">
         Module Index</a>
  <br><br>
  <h3><a href="../index.html">Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#"><code class="docutils literal notranslate"><span class="pre">state.py</span></code></a><ul>
<li><a class="reference internal" href="#code">Code</a></li>
</ul>
</li>
</ul>
<div class="relations">
<h3>Related</h3>
<ul>
  <li><a href="../index.html"></a><ul>
      <li><a href="parameters.html" title="previous chapter"><code class="docutils literal notranslate"><span class="pre">parameters.py</span></code></a></li>
      <li><a href="core.html" title="next chapter"><code class="docutils literal notranslate"><span class="pre">core.py</span></code></a></li>
  </ul></li>
</ul>
</div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018, CPS.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.7.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
      |
      <a href="../_sources/modules/state.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>