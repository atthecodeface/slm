
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>streamlining.py &#8212; Streamlines  documentation</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="parameters.py" href="parameters.html" />
    <link rel="prev" title="slm.py" href="slm.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="module-streamlines.streamlining">
<span id="streamlining-py"></span><h1><code class="docutils literal notranslate"><span class="pre">streamlining.py</span></code><a class="headerlink" href="#module-streamlines.streamlining" title="Permalink to this headline">¶</a></h1>
<hr class="docutils" />
<p>Perform <strong>slm</strong> analysis of topographic structure, including channels,
channel heads, hillslope lengths (HSL), and relationships between HSL, aspect,
etc.</p>
<hr class="docutils" />
<p>Requires <a class="reference external" href="https://docs.python.org/3/library/json.html">json</a>, <a class="reference external" href="https://docs.python.org/3/library/datetime.html">datetime</a>, <a class="reference external" href="https://pypi.org/project/python-dateutil/">dateutil</a>.</p>
<dl class="docutils">
<dt>Imports the following <em>Streamlines</em> modules:</dt>
<dd><ul class="first last simple">
<li><a class="reference internal" href="connect.html#module-streamlines.connect" title="streamlines.connect"><code class="xref py py-mod docutils literal notranslate"><span class="pre">connect</span></code></a></li>
<li><a class="reference internal" href="channelheads.html#module-streamlines.channelheads" title="streamlines.channelheads"><code class="xref py py-mod docutils literal notranslate"><span class="pre">channelheads</span></code></a></li>
<li><a class="reference internal" href="countlink.html#module-streamlines.countlink" title="streamlines.countlink"><code class="xref py py-mod docutils literal notranslate"><span class="pre">countlink</span></code></a></li>
<li><a class="reference internal" href="label.html#module-streamlines.label" title="streamlines.label"><code class="xref py py-mod docutils literal notranslate"><span class="pre">label</span></code></a></li>
<li><a class="reference internal" href="segment.html#module-streamlines.segment" title="streamlines.segment"><code class="xref py py-mod docutils literal notranslate"><span class="pre">segment</span></code></a></li>
<li><a class="reference internal" href="hillslopes.html#module-streamlines.hillslopes" title="streamlines.hillslopes"><code class="xref py py-mod docutils literal notranslate"><span class="pre">hillslopes</span></code></a></li>
<li><a class="reference internal" href="lengths.html#module-streamlines.lengths" title="streamlines.lengths"><code class="xref py py-mod docutils literal notranslate"><span class="pre">lengths</span></code></a></li>
</ul>
</dd>
<dt>Imports classes from:</dt>
<dd><ul class="first last simple">
<li><a class="reference internal" href="core.html#module-streamlines.core" title="streamlines.core"><code class="xref py py-mod docutils literal notranslate"><span class="pre">core</span></code></a></li>
<li><a class="reference internal" href="state.html#module-streamlines.state" title="streamlines.state"><code class="xref py py-mod docutils literal notranslate"><span class="pre">state</span></code></a></li>
<li><a class="reference internal" href="geodata.html#module-streamlines.geodata" title="streamlines.geodata"><code class="xref py py-mod docutils literal notranslate"><span class="pre">geodata</span></code></a></li>
<li><a class="reference internal" href="preprocess.html#module-streamlines.preprocess" title="streamlines.preprocess"><code class="xref py py-mod docutils literal notranslate"><span class="pre">preprocess</span></code></a></li>
<li><a class="reference internal" href="trace.html#module-streamlines.trace" title="streamlines.trace"><code class="xref py py-mod docutils literal notranslate"><span class="pre">trace</span></code></a></li>
<li><a class="reference internal" href="analysis.html#module-streamlines.analysis" title="streamlines.analysis"><code class="xref py py-mod docutils literal notranslate"><span class="pre">analysis</span></code></a></li>
<li><a class="reference internal" href="mapping.html#module-streamlines.mapping" title="streamlines.mapping"><code class="xref py py-mod docutils literal notranslate"><span class="pre">mapping</span></code></a></li>
<li><a class="reference internal" href="plot.html#module-streamlines.plot" title="streamlines.plot"><code class="xref py py-mod docutils literal notranslate"><span class="pre">plot</span></code></a></li>
<li><a class="reference internal" href="save.html#module-streamlines.save" title="streamlines.save"><code class="xref py py-mod docutils literal notranslate"><span class="pre">save</span></code></a></li>
</ul>
</dd>
</dl>
<p>Imports functions from <a class="reference internal" href="useful.html#module-streamlines.useful" title="streamlines.useful"><code class="xref py py-mod docutils literal notranslate"><span class="pre">useful</span></code></a>.</p>
<hr class="docutils" />
<dl class="class">
<dt id="streamlines.streamlining.Streamlining">
<em class="property">class </em><code class="descclassname">streamlines.streamlining.</code><code class="descname">Streamlining</code><span class="sig-paren">(</span><em>**kwargs</em><span class="sig-paren">)</span><a class="headerlink" href="#streamlines.streamlining.Streamlining" title="Permalink to this definition">¶</a></dt>
<dd><p>Class providing set of methods to compute streamline trajectories and
densities from raw DTM data.</p>
<dl class="docutils">
<dt>Provides top-level methods to:</dt>
<dd><ul class="first last simple">
<li>prepare DTM grid for streamline computation
by fixing blockages (single-diagonal-outflow pixels) and loops
(divergence, curl and net vector magnitude exceeding trio of thresholds)</li>
<li>set ‘seed’ points aka start locations (sub-pixel positions) of all streamlines</li>
<li>generate streamlines
from all seed points either upstream or downstream, returning seed point
locations if generated in-situ, and returning arrays of streamline points
and their mean spacing</li>
<li>generate all streamlines (up and downstream) and compute the overall
mean streamline point spacing</li>
</ul>
</dd>
</dl>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><strong>parameters_file</strong> (<em>class</em>) – Name of JSON parameters file prefixed by full path.</td>
</tr>
</tbody>
</table>
<dl class="attribute">
<dt id="streamlines.streamlining.Streamlining.parameters_file">
<code class="descname">parameters_file</code><a class="headerlink" href="#streamlines.streamlining.Streamlining.parameters_file" title="Permalink to this definition">¶</a></dt>
<dd><p><em>str</em> – Name of JSON parameters file
(parsed from kwargs ‘parameters_file’)</p>
</dd></dl>

<dl class="attribute">
<dt id="streamlines.streamlining.Streamlining.parameters_dir">
<code class="descname">parameters_dir</code><a class="headerlink" href="#streamlines.streamlining.Streamlining.parameters_dir" title="Permalink to this definition">¶</a></dt>
<dd><p><em>str</em> – Path to folder containing JSON parameters file
(parsed from kwargs ‘parameters_file’)</p>
</dd></dl>

<dl class="method">
<dt id="streamlines.streamlining.Streamlining.__init__">
<code class="descname">__init__</code><span class="sig-paren">(</span><em>**kwargs</em><span class="sig-paren">)</span><a class="headerlink" href="#streamlines.streamlining.Streamlining.__init__" title="Permalink to this definition">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><strong>**kwargs</strong> (<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#list" title="(in Python v3.7)"><em>list</em></a>) – Keyword arguments.</td>
</tr>
</tbody>
</table>
<p>Initialize the principal ‘streamlines’ class instance, whose object
will contain references to the each of the key class instances of
the streamlines workflow, e.g., geodata(), trace(), analysis()
Each such subobject will contain:</p>
<ul class="simple">
<li>attributes corresponding to all the parameters pertinent
to that stage of the workflow, e.g. state.do_plot, trace.do_trace_upstream,
parsed the parameters ‘dictionary of dictionaries’ file;</li>
<li>a reference to the inventorize() method, inherited from the Core() class,
used to do the parameter parsing;</li>
<li>back-references to all the key class instances needed for its work,
e.g., trace.geodata(), plot.state();</li>
<li>references to methods needed for its work,
e.g., preprocess.find_blockages(), trace.do();</li>
<li>attributes and references to objects generated during its work,
notably data arrays containing results</li>
</ul>
</dd></dl>

</dd></dl>

<div class="section" id="code">
<h2>Code<a class="headerlink" href="#code" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">---------------------------------------------------------------------</span>

<span class="sd">Perform **slm** analysis of topographic structure, including channels, </span>
<span class="sd">channel heads, hillslope lengths (HSL), and relationships between HSL, aspect,</span>
<span class="sd">etc.</span>

<span class="sd">---------------------------------------------------------------------</span>

<span class="sd">Requires `json`_, `datetime`_, `dateutil`_.</span>

<span class="sd">Imports the following *Streamlines* modules:</span>
<span class="sd"> - :mod:`connect &lt;streamlines.connect&gt;`</span>
<span class="sd"> - :mod:`channelheads &lt;streamlines.channelheads&gt;`</span>
<span class="sd"> - :mod:`countlink &lt;streamlines.countlink&gt;`</span>
<span class="sd"> - :mod:`label &lt;streamlines.label&gt;`</span>
<span class="sd"> - :mod:`segment &lt;streamlines.segment&gt;`</span>
<span class="sd"> - :mod:`hillslopes &lt;streamlines.hillslopes&gt;`</span>
<span class="sd"> - :mod:`lengths &lt;streamlines.lengths&gt;`</span>

<span class="sd">Imports classes from:</span>
<span class="sd"> - :mod:`core &lt;streamlines.core&gt;`</span>
<span class="sd"> - :mod:`state &lt;streamlines.state&gt;`</span>
<span class="sd"> - :mod:`geodata &lt;streamlines.geodata&gt;`</span>
<span class="sd"> - :mod:`preprocess &lt;streamlines.preprocess&gt;`</span>
<span class="sd"> - :mod:`trace &lt;streamlines.trace&gt;`</span>
<span class="sd"> - :mod:`analysis &lt;streamlines.analysis&gt;`</span>
<span class="sd"> - :mod:`mapping &lt;streamlines.mapping&gt;`</span>
<span class="sd"> - :mod:`plot &lt;streamlines.plot&gt;`</span>
<span class="sd"> - :mod:`save &lt;streamlines.save&gt;`</span>

<span class="sd">Imports functions from :mod:`useful &lt;streamlines.useful&gt;`.</span>

<span class="sd">---------------------------------------------------------------------</span>

<span class="sd">.. _json: https://docs.python.org/3/library/json.html</span>
<span class="sd">.. _datetime: https://docs.python.org/3/library/datetime.html</span>
<span class="sd">.. _dateutil: https://pypi.org/project/python-dateutil/</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">json</span>     <span class="k">import</span> <span class="n">loads</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">dateutil</span> <span class="k">import</span> <span class="n">tz</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PYTHONUNBUFFERED&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;True&#39;</span>

<span class="kn">from</span> <span class="nn">streamlines.core</span>       <span class="k">import</span> <span class="n">Core</span>
<span class="kn">from</span> <span class="nn">streamlines.parameters</span> <span class="k">import</span> <span class="n">read_json_file</span><span class="p">,</span> <span class="n">import_parameters</span>
<span class="kn">from</span> <span class="nn">streamlines.state</span>      <span class="k">import</span> <span class="n">State</span>
<span class="kn">from</span> <span class="nn">streamlines.geodata</span>    <span class="k">import</span> <span class="n">Geodata</span>
<span class="kn">from</span> <span class="nn">streamlines.preprocess</span> <span class="k">import</span> <span class="n">Preprocess</span>
<span class="kn">from</span> <span class="nn">streamlines.trace</span>      <span class="k">import</span> <span class="n">Trace</span>
<span class="kn">from</span> <span class="nn">streamlines.analysis</span>   <span class="k">import</span> <span class="n">Analysis</span>
<span class="kn">from</span> <span class="nn">streamlines.mapping</span>    <span class="k">import</span> <span class="n">Mapping</span>
<span class="kn">from</span> <span class="nn">streamlines.plot</span>       <span class="k">import</span> <span class="n">Plot</span>
<span class="kn">from</span> <span class="nn">streamlines.save</span>       <span class="k">import</span> <span class="n">Save</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Streamlining&#39;</span><span class="p">]</span>

<span class="n">pdebug</span> <span class="o">=</span> <span class="nb">print</span>

<span class="k">class</span> <span class="nc">Streamlining</span><span class="p">(</span><span class="n">Core</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class providing set of methods to compute streamline trajectories and </span>
<span class="sd">    densities from raw DTM data.</span>
<span class="sd">    </span>
<span class="sd">    Provides top-level methods to: </span>
<span class="sd">        - prepare DTM grid for streamline computation</span>
<span class="sd">          by fixing blockages (single-diagonal-outflow pixels) and loops </span>
<span class="sd">          (divergence, curl and net vector magnitude exceeding trio of thresholds)</span>
<span class="sd">        - set &#39;seed&#39; points aka start locations (sub-pixel positions) of all streamlines </span>
<span class="sd">        - generate streamlines</span>
<span class="sd">          from all seed points either upstream or downstream, returning seed point </span>
<span class="sd">          locations if generated in-situ, and returning arrays of streamline points </span>
<span class="sd">          and their mean spacing</span>
<span class="sd">        - generate all streamlines (up and downstream) and compute the overall</span>
<span class="sd">          mean streamline point spacing</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        parameters_file (class): Name of JSON parameters file prefixed by full path.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        parameters_file (str): Name of JSON parameters file </span>
<span class="sd">                               (parsed from kwargs &#39;parameters_file&#39;)</span>
<span class="sd">        parameters_dir (str): Path to folder containing JSON parameters file </span>
<span class="sd">                              (parsed from kwargs &#39;parameters_file&#39;)</span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">        &quot;&quot;&quot;</span>  
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    </span>
<span class="sd">        Args:</span>
<span class="sd">            **kwargs (list): Keyword arguments.</span>
<span class="sd">    </span>
<span class="sd">        Initialize the principal &#39;streamlines&#39; class instance, whose object</span>
<span class="sd">        will contain references to the each of the key class instances of </span>
<span class="sd">        the streamlines workflow, e.g., geodata(), trace(), analysis()</span>
<span class="sd">        Each such subobject will contain: </span>
<span class="sd">        </span>
<span class="sd">        - attributes corresponding to all the parameters pertinent </span>
<span class="sd">          to that stage of the workflow, e.g. state.do_plot, trace.do_trace_upstream,</span>
<span class="sd">          parsed the parameters &#39;dictionary of dictionaries&#39; file;</span>
<span class="sd">        - a reference to the inventorize() method, inherited from the Core() class,</span>
<span class="sd">          used to do the parameter parsing;</span>
<span class="sd">        - back-references to all the key class instances needed for its work,</span>
<span class="sd">          e.g., trace.geodata(), plot.state();</span>
<span class="sd">        - references to methods needed for its work,</span>
<span class="sd">          e.g., preprocess.find_blockages(), trace.do();</span>
<span class="sd">        - attributes and references to objects generated during its work, </span>
<span class="sd">          notably data arrays containing results</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="c1">#</span>
        <span class="c1"># Parse workflow parameters in JSON files and command line</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="s1">&#39;parameters_file&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Must specify a parameters JSON file&#39;</span><span class="p">)</span>
        <span class="n">parameters_path</span><span class="p">,</span> <span class="n">parameters_file</span>  <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;parameters_file&#39;</span><span class="p">])</span>
        <span class="c1"># Remove trailing .json for now if there is one</span>
        <span class="n">parameters_file</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parameters_file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.json&#39;</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="c1"># Look for the JSON file in several likely places</span>
        <span class="k">if</span> <span class="n">parameters_path</span><span class="o">==</span><span class="s1">&#39;&#39;</span><span class="p">:</span>   
            <span class="c1"># Try the current directory - in UNIX, the dir from which slm was invoked         </span>
            <span class="n">possible_paths</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;.&#39;</span><span class="p">]</span>
            <span class="c1"># Try the slm &quot;home&quot; dir given in the SLM environment variable</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">possible_paths</span> <span class="o">+=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;SLM&#39;</span><span class="p">],</span><span class="s1">&#39;json&#39;</span><span class="p">)]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="c1"># If we&#39;re running a Jupyter notebook in slmnb/, try the likely</span>
            <span class="c1">#   relative path to slm/json/</span>
            <span class="n">guess</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;..&#39;</span><span class="p">,</span><span class="s1">&#39;..&#39;</span><span class="p">,</span><span class="s1">&#39;slm&#39;</span><span class="p">,</span><span class="s1">&#39;json&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">guess</span><span class="p">):</span>
                <span class="n">possible_paths</span> <span class="o">+=</span> <span class="p">[</span><span class="n">guess</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">possible_paths</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">parameters_file</span><span class="o">+</span><span class="s1">&#39;.json&#39;</span><span class="p">))):</span>
                    <span class="n">parameters_path</span> <span class="o">=</span> <span class="n">path</span>
                    <span class="k">break</span>
            <span class="c1"># If we still can&#39;t find the specified JSON file, bail</span>
            <span class="k">if</span> <span class="n">parameters_path</span><span class="o">==</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cannot find JSON parameters file in </span><span class="si">{}</span><span class="s1">&#39;</span>
                                 <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">possible_paths</span><span class="p">))</span>
            
        <span class="c1"># Read in parameters and assign to the Trajectories class instance</span>
        <span class="n">imported_parameters</span><span class="p">,</span> <span class="n">slm_path</span><span class="p">,</span> <span class="n">slmdata_path</span><span class="p">,</span> <span class="n">slmnb_path</span> \
            <span class="o">=</span> <span class="n">import_parameters</span><span class="p">(</span><span class="n">parameters_path</span><span class="p">,</span> <span class="n">parameters_file</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="s1">&#39;verbose&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">or</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> 
                  <span class="s1">&#39;verbose&#39;</span> <span class="ow">in</span> <span class="n">imported_parameters</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> 
                   <span class="ow">and</span> <span class="n">imported_parameters</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">][</span><span class="s1">&#39;verbose&#39;</span><span class="p">])</span> 
             <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;verbose&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> 
                   <span class="ow">and</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">])):</span>
            <span class="c1"># dateutil seems like best way to insert local TZ info into naive datetime</span>
            <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="n">tz</span><span class="o">.</span><span class="n">tzlocal</span><span class="p">())</span>            
            <span class="nb">print</span><span class="p">(</span><span class="n">now</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">%a %Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S %Z%z&#39;</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">**Initialization begin**&#39;</span><span class="p">)</span> 
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Loaded JSON parameters file &quot;</span><span class="si">{}</span><span class="s1">&quot;&#39;</span>
                  <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parameters_path</span><span class="p">,</span> 
                                                        <span class="n">parameters_file</span><span class="o">+</span><span class="s1">&#39;.json&#39;</span><span class="p">))))</span>
        <span class="c1"># If the command line requires override of JSON-file parameters, make it happen</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">override_parameters</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;override_parameters&#39;</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">override_parameters</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">override_parameters</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">override_parameters</span><span class="o">!=</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="c1"># The override parameter string is itself JSON data </span>
            <span class="n">override_dict</span> <span class="o">=</span> <span class="n">loads</span><span class="p">(</span><span class="n">override_parameters</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">override_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">imported_parameters</span><span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1"># Instantiate the workflow &quot;state&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">State</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="n">imported_parameters</span><span class="p">)</span>
        <span class="c1"># Record the JSON parameters file path &amp; name </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">parameters_path</span> <span class="o">=</span> <span class="n">parameters_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">parameters_file</span> <span class="o">=</span> <span class="n">parameters_file</span>

        <span class="c1"># Parse command line args and assign to State attributes in most cases</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;do_plot&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;0&#39;</span> <span class="ow">or</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;off&#39;</span> <span class="ow">or</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;false&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">do_plot</span><span class="o">=</span><span class="kc">False</span>
                <span class="k">elif</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;maps&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">do_plot</span><span class="o">=</span><span class="kc">True</span>
                    <span class="n">imported_parameters</span><span class="p">[</span><span class="s1">&#39;plot&#39;</span><span class="p">][</span><span class="s1">&#39;do_plot_maps&#39;</span><span class="p">]</span><span class="o">=</span><span class="kc">True</span>
                    <span class="n">imported_parameters</span><span class="p">[</span><span class="s1">&#39;plot&#39;</span><span class="p">][</span><span class="s1">&#39;do_plot_distributions&#39;</span><span class="p">]</span><span class="o">=</span><span class="kc">False</span>
                <span class="k">elif</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;pdfs&#39;</span> <span class="ow">or</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;distributions&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">do_plot</span><span class="o">=</span><span class="kc">True</span>
                    <span class="n">imported_parameters</span><span class="p">[</span><span class="s1">&#39;plot&#39;</span><span class="p">][</span><span class="s1">&#39;do_plot_maps&#39;</span><span class="p">]</span><span class="o">=</span><span class="kc">False</span>
                    <span class="n">imported_parameters</span><span class="p">[</span><span class="s1">&#39;plot&#39;</span><span class="p">][</span><span class="s1">&#39;do_plot_distributions&#39;</span><span class="p">]</span><span class="o">=</span><span class="kc">True</span>
                <span class="k">elif</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;all&#39;</span> <span class="ow">or</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;1&#39;</span> \
                        <span class="ow">or</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;True&#39;</span> <span class="ow">or</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;true&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">do_plot</span><span class="o">=</span><span class="kc">True</span>
                    <span class="n">imported_parameters</span><span class="p">[</span><span class="s1">&#39;plot&#39;</span><span class="p">][</span><span class="s1">&#39;do_plot_maps&#39;</span><span class="p">]</span><span class="o">=</span><span class="kc">True</span>
                    <span class="n">imported_parameters</span><span class="p">[</span><span class="s1">&#39;plot&#39;</span><span class="p">][</span><span class="s1">&#39;do_plot_distributions&#39;</span><span class="p">]</span><span class="o">=</span><span class="kc">True</span>
                <span class="k">elif</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">do_plot</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="c1"># Used by State.inventorize_run_state() and other State methods</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">obj_list</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">]</span>
        
        <span class="c1"># Try to fetch latest slm-related git repo information</span>
        <span class="c1">#   - notably the commit hash, author, date &amp; time</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">do_git_info</span><span class="p">:</span>
            <span class="c1"># Avoid the need to have the Python git module installed</span>
            <span class="c1">#   by only importing if do_git_info is true</span>
            <span class="kn">import</span> <span class="nn">git</span>
            <span class="k">for</span> <span class="n">repo_name</span><span class="p">,</span> <span class="n">repo_path</span> <span class="ow">in</span> <span class="p">((</span><span class="s1">&#39;slm&#39;</span><span class="p">,</span><span class="n">slm_path</span><span class="p">),</span>
                                         <span class="p">(</span><span class="s1">&#39;slmnb&#39;</span><span class="p">,</span><span class="n">slmnb_path</span><span class="p">),</span>
                                         <span class="p">(</span><span class="s1">&#39;slmdata&#39;</span><span class="p">,</span><span class="n">slmdata_path</span><span class="p">)):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Create a short-lived git repo class instance</span>
                    <span class="n">repo</span> <span class="o">=</span> <span class="n">git</span><span class="o">.</span><span class="n">Repo</span><span class="p">(</span><span class="n">repo_path</span><span class="p">)</span>
                    <span class="c1"># Grab its summary - seems to be the fastest way to get git info</span>
                    <span class="n">summary</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">git</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="s1">&#39;--summary&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">git_info</span> <span class="o">=</span> <span class="p">[</span>  <span class="p">[</span><span class="n">summary</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">+</span><span class="p">[</span><span class="n">summary</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &lt;&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span><span class="o">+</span><span class="p">[</span><span class="n">summary</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> 
                                <span class="o">+</span> <span class="p">([</span><span class="n">summary</span><span class="p">[</span><span class="mi">4</span><span class="p">]]</span> <span class="k">if</span> <span class="n">summary</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;&#39;</span> <span class="k">else</span> <span class="p">[])</span> 
                                <span class="o">+</span> <span class="p">([</span><span class="n">summary</span><span class="p">[</span><span class="mi">5</span><span class="p">]]</span> <span class="k">if</span> <span class="n">summary</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;&#39;</span> <span class="k">else</span> <span class="p">[])</span> <span class="p">]</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">,</span><span class="n">repo_name</span><span class="o">+</span><span class="s1">&#39;_gitinfo&#39;</span><span class="p">,</span><span class="n">git_info</span><span class="p">)</span>
                    <span class="c1"># Print git info if verbose mode is on</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> git:&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">repo_name</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span><span class="n">git_info</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>
            
        <span class="c1"># Instantiate slm workflow classes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">geodata</span>    <span class="o">=</span> <span class="n">Geodata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">,</span><span class="n">imported_parameters</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">preprocess</span> <span class="o">=</span> <span class="n">Preprocess</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">,</span><span class="n">imported_parameters</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">geodata</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trace</span>      <span class="o">=</span> <span class="n">Trace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">,</span><span class="n">imported_parameters</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">geodata</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">preprocess</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">analysis</span>   <span class="o">=</span> <span class="n">Analysis</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">,</span><span class="n">imported_parameters</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">geodata</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mapping</span>    <span class="o">=</span> <span class="n">Mapping</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">,</span><span class="n">imported_parameters</span><span class="p">,</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">geodata</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">preprocess</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">analysis</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot</span>       <span class="o">=</span> <span class="n">Plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">,</span><span class="n">imported_parameters</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">geodata</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">preprocess</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapping</span><span class="p">)</span>
        <span class="c1"># Hackish way to allow plotting from mapping</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mapping</span><span class="o">.</span><span class="n">_augment</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save</span>       <span class="o">=</span> <span class="n">Save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">,</span><span class="n">imported_parameters</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">geodata</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocess</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis</span><span class="p">,</span> 
                               <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapping</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot</span><span class="p">)</span>
        <span class="c1"># Used by State.save_state()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">trace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span>
                             
        <span class="bp">self</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s1">&#39;**Initialization end**</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> 
    
</pre></div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../index.html">
    <img class="logo" src="../_static/../_images/icon2.png" alt="Logo"/>
    
    <h1 class="logo logo-name">Streamlines</h1>
    
  </a>
</p>



<p class="blurb">Topographic streamline mapping of landscape structure</p>







<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
  <br>
  <p class="biglink"><a class="biglink" href="../py-modindex.html">
         Module Index</a>
  <br><br>
  <h3><a href="../index.html">Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#"><code class="docutils literal notranslate"><span class="pre">streamlining.py</span></code></a><ul>
<li><a class="reference internal" href="#code">Code</a></li>
</ul>
</li>
</ul>
<div class="relations">
<h3>Related</h3>
<ul>
  <li><a href="../index.html"></a><ul>
      <li><a href="slm.html" title="previous chapter"><code class="docutils literal notranslate"><span class="pre">slm.py</span></code></a></li>
      <li><a href="parameters.html" title="next chapter"><code class="docutils literal notranslate"><span class="pre">parameters.py</span></code></a></li>
  </ul></li>
</ul>
</div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018, CPS.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.7.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
      |
      <a href="../_sources/modules/streamlining.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>